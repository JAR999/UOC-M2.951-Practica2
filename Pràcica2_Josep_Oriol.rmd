---
title: "M2.951_20192_Pràctica2"
author: "Oriol Calvo i Josep Adrian"
date: "Maig-Juny 2020"
output: 
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Llibreries que s'utiliten al llarg del notebook:
```{r message=FALSE}
library(lubridate)
library(ggplot2)
library(dplyr)
library(gridExtra)
library(VIM)
library(ggpubr)
library(con2aqi)
library(zoo)
library(nortest)
library(forecast)
library(corrplot)
```

# 1. Descripció del dataset. 

## 1.1 Perquè és important i quina pregunta/problema pretén respondre?

Escollim el dataset ["Beijing Multiset Air Quality"](https://archive.ics.uci.edu/ml/datasets/Beijing+Multi-Site+Air-Quality+Data) de UC Irvine Machine Learning

El dataset inclou medicions de diferents indicadors de contaminació ambiental recollides en 12 estacions atmosfèriques de la ciutat de Pequín, recollides entre el 1r de març de 2013 i el 28 de febrer de 2017.

L'estudi del dataset pretén arribar a conclusions rellevants sobre la qualitat de l'aire en aquesta ciutat asiàtica, una de les més contaminades del món segons diversos ranquings, que permetin a les autoritats prendre mesures per a reduïr la contaminació, i millorar així la qualitat de vida dels seus habitants, aconseguint també revertir l'efecte del canvi climàtic.

## 1.2 Descripció del dataset

El dataset es composa de 12 fitxers, cadascun d'aquets correspon a una estació de control de qualitat de l'aire d'on s'han obtingut mesures a cada hora des de 2013 fins al 2017. Cada fitxer per separat contè 35064 observacions.

El dataset complert contè un total de 455832 observacions i 18 atributs. Aquests atributs són:

- **No**: Número d'observació.
- **year**: Any de les dades.
- **month**: Mes de les dades.
- **day**: Dia de les dades.
- **hour**: Hora de les dades.
- **PM2.5**: Concentració del contaminant PM2,5 ($\mu g/m^3$).
- **PM10**: Concentració del contaminant PM10 ($\mu g/m^3$).
- **SO2**: Concentració de diòxid de sofre ($\mu g/m^3$).
- **NO2**: Concentració de diòxid de nitrogen ($\mu g/m^3$).
- **CO**: Concentració de monòxid de carboni ($\mu g/m^3$).
- **O3**: Concentració d'ozó ($\mu g/m^3$).
- **TEMP**: Temperatura (graus Celsius).
- **PRES**: Pressió ($hPa$).
- **DEWP**: Punt de rosada, temperatura a la qual ha de baixar una massa d'aire, a pressió constant, perquè la humitat relativa arribi al 100% (graus Celsius).
- **RAIN**: Preciptació ($mm$).
- **wd**: Direcció del vent.
- **WSPM**: Velocitat del vent ($m/s$).
- **station**: nom de l'estació de control.

# 2. Integració i selecció de les dades d’interès a analitzar.

## 2.1 Càrrega fitxer

Carreguem el fitxer i en mostrem estadístics bàsics
```{r}
rm(list=ls())

ruta="PRSA_Data_20130301-20170228/"

fitxers=list.files(ruta)

dades<-read.csv(paste(ruta,fitxers[1],sep=""), header=T, sep=",")

for (i in 2:length(fitxers)) {
  dades_i<-read.csv(paste(ruta,fitxers[i],sep=""), header=T, sep=",")
  dades=rbind(dades,dades_i)
}
write.csv(dades,"Dades_modificades.csv")
rm(dades_i,i,fitxers,ruta)
```

## 2.2  Preparació de les dades

A continuació discretitzarem algunes de les dades del conjunt, que es presenten originalment de forma contínua. La discretització ens ajudara a treballar millor amb les dades i a explicar-les millor de manera que els resultats siguin més rellevants i entenedors.

Primerament observem el dataset per veure quins valors poden ser discretitzats.
```{r}
apply(dades,2, function(x) length(unique(x)))
```

Discretitzem les variables amb menys classes, que funcionalment representen variables categòriques (dies, hores, direcció del vent...).
```{r}
# any
dades$year=as.factor(dades$year)
# mes
dades$month=as.factor(dades$month)
# dia
dades$day=as.factor(dades$day)
# hora
dades$hour=as.factor(dades$hour)
# direcció del vent
dades$wd=as.factor(dades$wd)
# nom de l'estació
dades$station=as.factor(dades$station)
```

### 2.2.1 Creació de nous atributs

Creem noves variables

- **RAIN_BOOL**: indica si plovia en aquella medició.
- **WIND**: indica si feia vent en aquella medició.
- **Direccio**: indica la direcció del vent en graus.
- **Data_Cal**: data de la observació creada a partir de dia-mes-any.
- **Estacio_any**: Hivern, Primavera, Estiu o Tardor (segons el mes).

```{r}
# RAIN_BOOL
dades$RAIN_BOOL<-"Pluja"
dades$RAIN_BOOL[dades$RAIN==0]<-"Sense pluja"
dades$RAIN_BOOL<-as.factor(dades$RAIN_BOOL)

# WIND
dades$WIND<-"Vent"
dades$WIND[dades$WSPM<1]<-"Sense vent"
dades$WIND<-as.factor(dades$WIND)

# direccio
dades$direccio[dades$wd=="N"]<-0
dades$direccio[dades$wd=="NNE"]<-22.5
dades$direccio[dades$wd=="NE"]<-45
dades$direccio[dades$wd=="ENE"]<-67.5
dades$direccio[dades$wd=="E"]<-90
dades$direccio[dades$wd=="ESE"]<-112.5
dades$direccio[dades$wd=="SE"]<-135
dades$direccio[dades$wd=="SSE"]<-157.5
dades$direccio[dades$wd=="S"]<-180
dades$direccio[dades$wd=="SSW"]<-202.5
dades$direccio[dades$wd=="SW"]<-225
dades$direccio[dades$wd=="WSW"]<-247.5
dades$direccio[dades$wd=="W"]<-270
dades$direccio[dades$wd=="WNW"]<-292.5
dades$direccio[dades$wd=="NW"]<-315
dades$direccio[dades$wd=="NNW"]<-337.5
#dades$direccio=as.factor(dades$direccio)

# Data_Cal
dades$Data_Cal <- ymd_h(paste(dades$year, dades$month, dades$day, dades$hour, sep= ' '))

# estacio_any
dades$estacio_any[dades$month==1 |dades$month==2|dades$month==3]<-"Hivern"
dades$estacio_any[dades$month==4 |dades$month==5|dades$month==6]<-"Primavera"
dades$estacio_any[dades$month==7 |dades$month==8|dades$month==9]<-"Estiu"
dades$estacio_any[dades$month==10 |dades$month==11|dades$month==12]<-"Tardor"
dades$estacio_any=as.factor(dades$estacio_any)
```

A continuació generem el mateix dataset amb una reducció d'intàncies. L'objectiu és calcular l'índex AQI per estudiar la qualita del aire. Aquest index es calcula de moltes maneres. La manera que hem escollit és amb el promig temporal de 24h dels indicadors *PM2.5*i*PM10*.

Per fer aixo caldrà fer aquesta reducció:
```{r}
red.dim <- function(df,dx){
  
  att.avg <- c("PM2.5","PM10","SO2","NO2","CO","O3","TEMP","PRES","RAIN","WSPM","direccio")
  att.sampling <-c("station","Data_Cal")
  
  aux <- aggregate(df[att.avg],list(rep(1:(nrow(df[att.avg])%/%dx+1),each=dx,len=nrow(df[att.avg]))),mean)[-1]
  vector.aux1 <- seq(1,nrow(df),by = dx)
  aux1 <- df[att.sampling]
  aux1 <- aux1[vector.aux1,]
  aux2 <- bind_cols(aux,aux1)
  
  return(aux2)
}

dades.24h <- red.dim(dades,24)
dades.24h$direccio <- as.factor(dades.24h$direccio)
dades$direccio <- as.factor(dades$direccio)
head(dades.24h)
```


## 2.4 Anàlisi descriptiva

A continuació classifiquem els atributs en funció del tipus de variable:

- **No**: Variable quantitativa discreta.
- **year**: Variable quantitativa discreta.
- **month**: Variable quantitativa discreta.
- **day**: Variable quantitativa discreta.
- **hour**: Variable quantitativa discreta.
- **PM2.5**: Variable quantitativa continua.
- **PM10**: Variable quantitativa continua.
- **SO2**: Variable quantitativa continua.
- **NO2**: Variable quantitativa continua.
- **CO**: Variable quantitativa continua.
- **O3**: Variable quantitativa continua.
- **TEMP**: Variable quantitativa continua.
- **PRES**: Variable quantitativa continua.
- **DEWP**: Variable quantitativa continua.
- **wd**: Variable qualitativa Nominal.
- **WSPM**: Variable quantitativa continua.
- **station**: Variable qualitativa nominal.
- **RAIN_BOOL**: Variable qualitativa dicotòmica.
- **WIND**: Variable qualitativa dicotòmica.
- **Direccio**: Variable quantitativa continua.
- **Data_Cal**: Variable quantitativa discreta.
- **Estacio_any**: Variable qualitativa nominal.

### 2.4.1 Estadística descriptiva

Mostrem les mesures de tendència central  i les mesures de dipersió pels atributs del conjunt de dades. Per al contjunt d'atributs quantitatius mostrarem els valors mínims, màxims, mediana, mitjana i quantils. En el cas dels atributs qualitatius mostrarem les seves freqüències. 

Primer es mostra la descripció del dataset original:
```{r}
summary(dades)
```

Després es mostra el dataset amb la reducció d'instàncies:
```{r}
summary(dades.24h)
```

## 2.5 Exploració visual de les dades

### 2.5.1 Exploració dataset original

Explorem gràficament les dades per a mirar de detectar patrons de conducta.
```{r  fig.height=6, fig.width=12}

p1<-ggplot(dades,aes(x=year,fill=direccio))+geom_bar(position="fill")
p2<-ggplot(dades,aes(x=month,fill=direccio))+geom_bar(position="fill")
p3<-ggplot(dades,aes(x=day,fill=direccio))+geom_bar(position="fill")
p4<-ggplot(dades,aes(x=hour,fill=direccio))+geom_bar(position="fill")

grid.arrange(p1, p2, p3, p4, ncol=2)

p1<-ggplot(dades,aes(x=year,fill=RAIN_BOOL))+geom_bar(position="fill")
p2<-ggplot(dades,aes(x=month,fill=RAIN_BOOL))+geom_bar(position="fill")
p3<-ggplot(dades,aes(x=day,fill=RAIN_BOOL))+geom_bar(position="fill")
p4<-ggplot(dades,aes(x=hour,fill=RAIN_BOOL))+geom_bar(position="fill")

grid.arrange(p1, p2, p3, p4, ncol=2)

p1<-ggplot(dades,aes(x=year,fill=WIND))+geom_bar(position="fill")
p2<-ggplot(dades,aes(x=month,fill=WIND))+geom_bar(position="fill")
p3<-ggplot(dades,aes(x=day,fill=WIND))+geom_bar(position="fill")
p4<-ggplot(dades,aes(x=hour,fill=WIND))+geom_bar(position="fill")

grid.arrange(p1, p2, p3, p4, ncol=2)

par(mfrow=c(2,2))

p1<-boxplot(dades$TEMP~dades$year)
p2<-boxplot(dades$TEMP~dades$month)
p3<-boxplot(dades$TEMP~dades$day)
p4<-boxplot(dades$TEMP~dades$hour)

par(mfrow=c(2,2))
p1<-boxplot(dades$PM10~dades$year)
p2<-boxplot(dades$PM10~dades$month)
p3<-boxplot(dades$PM10~dades$day)
p4<-boxplot(dades$PM10~dades$hour)

par(mfrow=c(2,2))
p1<-boxplot(dades$CO~dades$year)
p2<-boxplot(dades$CO~dades$month)
p3<-boxplot(dades$CO~dades$day)
p4<-boxplot(dades$CO~dades$hour)

par(mfrow=c(2,2))
p1<-boxplot(dades$RAIN~dades$year)
p2<-boxplot(dades$RAIN~dades$month)
p3<-boxplot(dades$RAIN~dades$day)
p4<-boxplot(dades$RAIN~dades$hour)

rm(p1,p2,p3,p4)
```

Observem diversos patrons com:

- El vent bufa generalment del sud i de l'oest a la tarda, mentre que als matins ho fa generalment del nord i l'est.
- El vent bufa generalment més durant el dia que no pas durant la nit.
- L'època de precipitacions més forta es dóna en els mesos d'estiu.
- La temperatura és també més alta en els mesos d'estiu.
- La concentració de partícules és generalment més alta en les hores punta del dia i en els mesos d'hivern

### 2.5.2 Exploració dataset reduit amb increments de 24h

Explorem gràficament les dades per a mirar de detectar patrons de conducta.

Primer es busca la dispersió de cadascun dels atributs respecte al temps. Es diferencien els mesos de forma que es pot obserar la distribució per cada any i cada mes.
```{r  fig.height=10, fig.width=12}
aux <- na.omit(dades.24h)
p1<-ggplot(aux,aes(x=Data_Cal,y=PM2.5, color = as.factor(month(aux$Data_Cal))))+
  geom_point() + ggtitle("PM2.5 vs temps")+ labs(color = "Mes")
p2<-ggplot(aux,aes(x=Data_Cal,y=PM10, color = as.factor(month(aux$Data_Cal)))) +
  geom_point()+ ggtitle("PM10 vs temps")+ labs(color = "Mes")
p3<-ggplot(aux,aes(x=Data_Cal,y=SO2, color = as.factor(month(aux$Data_Cal)))) +
  geom_point()+ ggtitle("SO2 vs temps")+ labs(color = "Mes")
p4<-ggplot(aux,aes(x=Data_Cal,y=NO2, color = as.factor(month(aux$Data_Cal)))) +
  geom_point()+ ggtitle("NO2 vs temps")+ labs(color = "Mes")
p5<-ggplot(aux,aes(x=Data_Cal,y=CO, color = as.factor(month(aux$Data_Cal)))) +
  geom_point()+ ggtitle("CO vs temps")+ labs(color = "Mes")
p6<-ggplot(aux,aes(x=Data_Cal,y=O3, color = as.factor(month(aux$Data_Cal)))) +
  geom_point()+ ggtitle("O3 vs temps")+ labs(color = "Mes")

grid.arrange(p1, p2, p3, p4,p5,p6,ncol=2)

rm(p1,p2,p3,p4,p5,p6,aux)
```

```{r  fig.height=8, fig.width=12}
aux <- na.omit(dades.24h)
p1<-ggplot(aux,aes(x=PM2.5,y=CO, color = as.factor(month(aux$Data_Cal))))+
  geom_point() + ggtitle("PM2.5 vs CO")+ labs(color = "Mes")
p2<-ggplot(aux,aes(x=PM10,y=CO, color = as.factor(month(aux$Data_Cal)))) +
  geom_point()+ ggtitle("PM10 vs CO")+ labs(color = "Mes")
p3<-ggplot(aux,aes(x=PM2.5,y=NO2, color = as.factor(month(aux$Data_Cal))))+
  geom_point() + ggtitle("PM2.5 vs NO2")+ labs(color = "Mes")
p4<-ggplot(aux,aes(x=NO2,y=O3, color = as.factor(month(aux$Data_Cal)))) +
  geom_point()+ ggtitle("NO2 vs O3")+ labs(color = "Mes")
p5<-ggplot(aux,aes(x=TEMP,y=O3, color = as.factor(month(aux$Data_Cal)))) +
  geom_point()+ ggtitle("TEMP vs O3")+ labs(color = "Mes")
grid.arrange(p1,p2,p3,p4,p5,ncol=2)

rm(p1, p2,p3, p4,p5,aux)
```

S'observa com en funció del mes hi ha un increment dels indicadors, per tant cosiderem important realitzar un estudi de les series temporals per entendre el comportament dels indicadors.

Tambés es pot apreciar com al juny de 2015 hi ha un pic molt alt de *CO*, correspon a un comportament inusual.

## 2.6 Estudis de la qualitat de l'aire 

Observarem la qualiat de l'aire de les mesures a partir de les dades dels indicadors. Segons els estàndards de la qualitat de l'aire https://ec.europa.eu/environment/air/quality/standards.htm els nivells no haurien de superar:

* PM2.5 > 25ug/m3 en mitjana anual
* PM10 > 50ug/m3 en mitjana diaria + 40ug/m3 en mitjana anual

```{r}

#Omitim valors nuls per a calcular la mitja mòbil
dades2 <- na.omit(dades.24h)

#Calculem la mitja mòbil anual i diària, pels indicadors seleccionats
Pm2.5_year=(rollapply(dades2$PM2.5,365,mean))
Pm10_year=(rollapply(dades2$PM10,365,mean))
Pm10_day=(rollapply(dades2$PM10,1,mean))

#Obtenim els valors corresponents de les dates de la mitja mòbil
dates_anys=dades2$Data_Cal[(365):nrow(dades2)]
dates_dies=dades2$Data_Cal[1:nrow(dades2)]


#Creem 2 datasets per guardar les mitges mòbils diàries i anuals
dades_anuals_mm=data.frame(data=dates_anys,Pm2.5_year,Pm10_year)
dades_diaries_mm=data.frame(data=dates_dies,Pm10_day)


#Dibuixem les dades amb la línia de referència de cada mesura
p<-ggplot(data=dades_diaries_mm,aes(x=data,y=Pm10_day)) + geom_line() 
p+geom_hline(yintercept=50, color = "red")

p<-ggplot(data=dades_anuals_mm,aes(x=data,y=Pm10_year)) + geom_line() 
p+geom_hline(yintercept=40, color = "red")

p<-ggplot(data=dades_anuals_mm,aes(x=data,y=Pm2.5_year)) + geom_line() 
p+geom_hline(yintercept=25, color = "red")

#rm(p,Pm2.5_year,Pm10_year,Pm10_day,dades_anuals_mm,dades_diaries_mm,dates_anys,dates_dies)

```

Observem que les dades mitjanes per any i per dia estan molt per sobre de les recomanades per les autoritats mediambientals.

## 2.7 Estudis efectes principals i interaccions

A continuació estudiarem els efectes principals i les interaccions entre algunes de les variables que observem gràficament que poden ser importants per a l'estudi.

### 2.7.1 Efecte de la direcció del vent en PM10 segons la pluja

```{r message=FALSE, warning=FALSE}
dades2 <- na.omit(dades)
taula_resum=summarise_at(group_by(dades2,direccio,RAIN_BOOL),vars(PM10),list(mean))

ggplot(taula_resum, aes(x = direccio, y = PM10, fill = RAIN_BOOL)) + 
    stat_summary(aes(group = RAIN_BOOL, color = RAIN_BOOL), fun = "mean", geom = "line", 
                 position = position_dodge(.2), size = 1) + 
    labs(title = "Efecte de la direcció del vent en la quantitat de partícules segons pluja", 
         x = "Direcció del vent", y = "PM10") + 
    theme_bw(base_size = 12) + 
    theme(panel.grid.major.x = element_blank(),
          axis.ticks.x = element_blank())
```

El gràfic resultant ens permet interpretar que la direcció del vent té efecte sobre la concentració de PM10 (ja que les línies no son horitzontals) i que la pluja també en té (ja que les línies no se superposen). Adicionalment als efectes principals, el gràfic ens permet afirmar que les variables presenten interacció entre elles, ja que les línies no son paral·leles. Clarament, quan plou, la direcció del vent no és tan important per determinar la concentració de partícules.

### 2.7.2 Efecte de la direcció del vent en PM10 segons l'estació de l'any

Repetim l'estudi segons l'estació de l'any.
```{r message=FALSE, warning=FALSE}
dades2 <- na.omit(dades)
taula_resum=summarise_at(group_by(dades2,direccio,estacio_any),vars(PM10),list(mean))

ggplot(taula_resum, aes(x = direccio, y = PM10, fill = estacio_any)) + 
    stat_summary(aes(group = estacio_any, color = estacio_any), fun = "mean", geom = "line", 
                 position = position_dodge(.2), size = 1) + 
    labs(title = "Efecte de la direcció del vent en la quantitat de partícules segons estació any", 
         x = "Direcció del vent", y = "PM10") + 
    theme_bw(base_size = 12) + 
    theme(panel.grid.major.x = element_blank(),
          axis.ticks.x = element_blank())

rm(taula_resum)

```

El gràfic resultant ens confirma la dependència de la quantitat de partícules segons la direcció del vent així com de l'estació de l'any. Adicionalment el gràfic ens permet afirmar que les variables no presenten interacció entre elles, ja que les línies guarden un cert paral·lelisme.

# 3. Neteja de les dades.
## 3.1. Les dades contenen zeros o elements buits? Com gestionaries aquests casos?

En aquest cas les dades quantitatives poden contenir el valor 0 degut a que corresponen a temperatures, precipitacions i densitats. Per tant, els valors perduts s'indiquen amb el valor *NaN* o *Not a Number*.

El primer pas és localitzar els valors perduts. Per això es mostra a continuació el nombre de valors perduts per cada atribut.

Per el dataset sencer:
```{r}
valors_perduts=colSums(is.na(dades))
valors_perduts
```

Per el dataset de 24h:
```{r}
valors_perduts.24h=colSums(is.na(dades.24h))
valors_perduts.24h
```

Hi han múltiples opcions per tractar els valors perduts:

- Eliminar les instàncies que continguin valors perduts.
- Substituir els valors perduts amb la mitja o media del atribut. 
- Aplicar model numèric per trobar els valors possibles.

En el cas d'eliminar les instàncies amb valors *NaN* ho fariem com:
```{r}
dades.na_omited <- na.omit(dades)
```

Enlloc d'eliminar els valors perduts, subtituim els valors perduts amb la mitja dels atributs i aplicarem  models numèrics (**k-nearest neighbours**) pels atributs *PM2.5* i *PM10*.

Agrupem les dades perdudes per hora i per mes. Observem que estan aproximadament distribuïdes per totes les categories.
```{r fig.height=5, fig.width=10}
#Exemple valors perduts per PM10
dades_perdudes_PM10=subset(dades,is.na(dades$PM10))

barplot(tapply(dades_perdudes_PM10$PM10,dades_perdudes_PM10$hour,length),las=2,xlab = "Estació",ylab="Total valors perduts",main="Valors perduts PM10 per hora")
barplot(tapply(dades_perdudes_PM10$PM10,dades_perdudes_PM10$month,length),xlab = "Mes",ylab="Total valors perduts",main="Valors perduts PM10 per mes")

rm(dades_perdudes_PM10)

```

## 3.2. Identificació i tractament de valors extrems.

Identifiquem els valors extrems de les variables i els deixem com *NaN*.
```{r fig.height=15, fig.width=10}
#PENDENT: Quin tractament es fa als valors extrems??

remove_outliers <- function(x, na.rm = TRUE, ...) {
  qnt <- quantile(x, probs=c(.25, .75), na.rm = na.rm, ...)
  H <- 1.5 * IQR(x, na.rm = na.rm)
  y <- x
  y[x < (qnt[1] - H)] <- NA
  y[x > (qnt[2] + H)] <- NA
  y
}

dades3 <- dades.24h
atributs <- c("PM2.5","PM10","SO2","NO2","CO","O3")

for(i in atributs){
  dades3[[i]]<-remove_outliers(dades.24h[[i]])
}  

aux.24h <- dades3 

par(mfrow=c(6,2))

# PM2.5
boxplot(dades.24h$PM2.5, main="Boxplot PM2.5 amb outliers")
boxplot(dades3$PM2.5, main="Boxplot PM2.5 sense outliers")
# PM10
boxplot(dades.24h$PM10, main="Boxplot PM10 amb outliers")
boxplot(dades3$PM10, main="Boxplot PM10 sense outliers")
# SO2
boxplot(dades.24h$SO2, main="Boxplot SO2 amb outliers")
boxplot(dades3$SO2, main="Boxplot SO2 sense outliers")
# NO2
boxplot(dades.24h$NO2, main="Boxplot NO2 amb outliers")
boxplot(dades3$NO2, main="Boxplot NO2 sense outliers")
# CO
boxplot(dades.24h$CO, main="Boxplot CO amb outliers")
boxplot(dades3$CO, main="Boxplot CO sense outliers")
# O3
boxplot(dades.24h$O3, main="Boxplot O3 amb outliers")
boxplot(dades3$O3, main="Boxplot O3 sense outliers")

rm(atributs,i)
```

### 3.3 Estimació valors perduts per al set de dades reduit 

Es realitza el mateix procés però pel model reduit de 24h. Es realitza amb el model KNN l'obtenció del parametres "PM2.5", "PM10", "TEMP", "PRES", "RAIN", "WSPM", "direccio", "station" i "Data_Cal".
```{r}
stations=unique(aux.24h$station)
hours=unique(aux.24h$hour)
total_station=length(stations)
total_hour=length(hours)

#Seleccionem 7 de les variables "month","hour","station","PM10","PM2.5","wd" i "WSPM".
attibuts <- c("PM2.5","PM10","SO2","NO2","CO","O3","station","Data_Cal")
dades_sample <- aux.24h[attibuts]
dades.24hmod <- aux.24h
for (i in 1:total_station){
    subset=subset(dades_sample,dades_sample$station==stations[i])
    dades_imp_i=kNN(subset,k=3)
    dades.24hmod$PM10[dades_sample$station==stations[i]]=dades_imp_i$PM10
    dades.24hmod$PM2.5[dades_sample$station==stations[i]]=dades_imp_i$PM2.5
    dades.24hmod$SO2[dades_sample$station==stations[i]]=dades_imp_i$SO2
    dades.24hmod$NO2[dades_sample$station==stations[i]]=dades_imp_i$NO2
    dades.24hmod$CO[dades_sample$station==stations[i]]=dades_imp_i$CO
    dades.24hmod$O3[dades_sample$station==stations[i]]=dades_imp_i$O3

    #print(stations[i])
}
dades.24hmod$mes <- as.numeric(month(dades.24hmod$Data_Cal))
dades.24hmod$year <- as.numeric(year(dades.24hmod$Data_Cal))


rm(hours,i,stations,total_hour,total_station,subset,dades_imp_i,attibuts,dades_sample)
```

Guardem els datasets amb les dades tractades.
```{r}
write.csv(dades,"Dades_modificades.csv")
write.csv(dades.24h,"Dades_modificades_24h.csv")
```

# 4. Anàlisi de les dades.

## 4.1. Selecció dels grups de dades que es volen analitzar/comparar (planificació dels anàlisis a aplicar).

Per poder realitzar el seguit de proves estadístiques, es determina el set de dades amb el qual es treballa.

En aquest cas es tria el set de dades reduides en mostres diaries per reduir de forma considerable el volum de informació amb el qual es treballa, i un cop s'han tractat els seus valors extrems i valors *NaN*.
```{r}
#Es mostra el set de dades reduides amb el qual es treballaran les proves estadístiques
summary(dades.24hmod)
```

Abans de poder determinar quin tipus d'analisi es vol desenvolupar, cal primer estudiar la distribució de cadascun dels atributs que conformen el data set i la seva variança. En funció dels resultats obtinguts es determina quin tipus d'estudi escau millor.

## 4.2. Comprovació de la normalitat i homogeneïtat de la variància.

De tots els atributs que té el nostre set de dades, les que són de principal interes són: **PM2.5**, **PM10**, **SO2**, **NO2**, **CO2** i **O3**. Aquets són els atributs que permeten quantificar la qualitat de l'aire.

Es defineix una variable amb els noms dels atributs.
```{r}
atributs <- c("PM2.5","PM10","SO2","NO2","CO","O3")
```

### 4.2.1 Comprovació normalitat

Es comprova de forma no parametrica la distribució normal de les dades.
```{r fig.height=8, fig.width=10}

# Visualització de la distribució de les dades en funció de cada atribut
par(mfrow=c(2,3))

for(i in atributs){
  qqnorm(dades.24hmod[[i]], main=paste("Distribució ",i))
  qqline(dades.24hmod[[i]],col=2)
}

```

Com s'observa en les gràfiques, els esmentats atributs no compleixen la distribució normal. Tot i això ho acompanyem del test pertinent. Per realitzar la prova, es fa ús de la funció *Anderson-Darling*. Aquesta funció permet estudiar la supossada distribució normal dels atributs sense límit de mostres. Com en aquest cas es té una gran quantitat d'instàncies, caldrà fer ús d'aquesta funció.
```{r}
for(i in atributs){
  aux <-ad.test(dades.24hmod[[i]])
  print(paste("Per l'atribut",i,"s'obté el valor p:", aux$p.value))
}
```

Tant amb els gràfics com amb els calculs de *Anderson-Darling*, s'obté que no es compleix la distribució de normalitat.

En cas de voler realitzar proves estadístiques que requereixin condició de normalitat, hi ha un conjunt de funcions *BOXCOX* que permeten transformar les dades i obenir així una distribució normal d'aquestes. Per ara no s'implementa.

### 4.2.2 Comprovació homogeneitat variables

A continuació s'estudia la homogeneiat de les dades, per poder procedir s'ha de tenir en compte que les dades no tenen una distribució normal, per aquest motiu s'estudiara segons *Fligner-Killeen*.

Es busca comprovar si les variances dels diferents atributs són iguals en funció de la estació de mesura.
```{r}
for(i in atributs){
  aux <-fligner.test(dades.24hmod[[i]],dades.24hmod$station)
  print(paste("Per l'atribut",i,"en funció de l'estació de mesura s'obté el valor p:", aux$p.value))
}
```

En aquest cas, es rebutja la hipòtesi nul·la d’homoscedasticitat degut a que el valor p és menor a index de significancia fixat com a 0.05 (5%), i es conclou que les diferents variables presenten variàncies estadísticament diferents per als diferents grups de *station*.

Es torna a calcular, però en aquest cas per múltiples aributs en funció de l'any. S'obté el mateix resultat, es segueix rebutjant la hipòtesi nul·la d'homoscedasticitat.
```{r}
for(i in atributs){
  aux <-fligner.test(dades.24hmod[[i]],dades.24hmod$year)
  print(paste("Per l'atribut",i,"en funció de l'any s'obté el valor p:", aux$p.value))
}
```

## 4.3. Aplicació de proves estadístiques al grup de dades.

### a) Comparció de les mitjanes dels grups

Amb l'objectiu de comparar si les mitajes dels diferents index que permeten quantificar la qualitat de l'aire varien en funció de l'estació de mesura, es realitza el següent estudi.

Com que els atributs no tenen una distribució normal i no tenen variancia constant en funció de l'estació de mesura es realitza l'estudi segons *Kruskal*.

```{r}
aux <- dades.24hmod
aux$station <- as.numeric(aux$station)
for(i in atributs){
  rs <-kruskal.test(aux[[i]],aux$station)
  print(paste("Per l'atribut",i,"en funció de l'estació de mesura s'obté el valor p:", rs$p.value))
}
```
Es conclou que presenta mitjanes diferents per a cadascun dels atributs en funció de l'estació de mesura.

Es realitza el mateix test en funció del mateixos atributs i l'any.
```{r}
for(i in atributs){
  rs <-kruskal.test(aux[[i]],aux$year)
  print(paste("Per l'atribut",i,"en funció de l'any de mesura s'obté el valor p:", rs$p.value))
}
```

Es conclou que presenta mitjanes diferents per a cadascun dels atributs en funció de l'any de mesura.

### b) Correlació entre atributs

Es vol entendre quina relació hi ha entre les diferents variables qe conformen el ataset d'estudi, per fer-ho, es realitza un estudi de correlació. Com que les dades no tenen una distribució normal, el mètode de càlcul serà *Spearman*.

A continuació es mostra la correlació entre atributs numèrics:
```{r}
atributs.numerics <- c("PM2.5","PM10","SO2","NO2","CO","O3","mes","year")
cor(dades.24hmod[atributs.numerics],method = "spearman")
```

Una altra manera més clarificadora de veure-ho es:
```{r message=FALSE, warning=FALSE}
corr <- cor(dades.24hmod[atributs.numerics],method = "spearman")
corrplot(corr, method="circle")
```

S'observa com entre els atributs **PM2.5**, **PM10**, **SO2**, **NO2** i **CO2**, hi ha una correlació possitiva. Encanvi, aquests mateixos atributs amb **O3**, tenen una correlació negativa. El mes i l'any no tenen una forta correlació amb la resta d'atributs.

En aquest cas concret s'estudia el grau de corelació entre els atributs **PM2.5** i **PM0**.
```{r}
cor.test(dades.24hmod$PM2.5,dades.24hmod$PM10,method="spearman", exact=F)
```

S'observa com el valor p ens fa ebutjar la hipòtesi nul·la descartant que la correlacio sigui 0 (no correlació) i el valor *ro* és proper a 1. Per tan es confirma una forta correlació, això unit a que es coneix que hi ha una correació positiva ens determina que quan un dels ds atributs creix l'altre també.

```{r}
ggplot(dades.24hmod,aes(x=PM2.5,y=PM10, ))+
geom_point() + ggtitle("PM2.5 vs PM10")
```

Aquest anàlisi es pot realitzar per a tots els atributs que es mostren. Nosaltres h farem també per l'atribut *O3* que ens interessa en el següent apartat.
```{r}
cor.test(dades.24hmod$PM2.5,dades.24hmod$O3,method="spearman", exact=F)
```

En aquest cas s'observa com no hi ha una clara significancia entre la correlació. Existeix una correlació negativa pero no és concluent.

Si es compara **O3** amb l'atribut **mes** obtenim que els resultats tampoc són gaire concloents. Es a dir, exiteix correlació però és molt baixa i és inferior a +- 0.5.
```{r}
cor.test(dades.24hmod$mes,dades.24hmod$O3,method="spearman", exact=F)
```

### c) Anàlisi de tendència i estacionalitat

Volem estudiar la tendència i estacionalitat de les dades, per fer-ho farem una reducció d'instàncies o reduirem a una instància per mes i any.
```{r}
PM2.5 <- aggregate(PM2.5 ~ mes + year+station, dades.24hmod, FUN=mean)
PM10 <- aggregate(PM10 ~ mes + year+station, dades.24hmod, FUN=mean)
SO2 <- aggregate(SO2 ~ mes + year+station, dades.24hmod, FUN=mean)
NO2 <- aggregate(NO2 ~ mes + year+station, dades.24hmod, FUN=mean)
CO <- aggregate(CO ~ mes + year+station, dades.24hmod, FUN=mean)
O3 <- aggregate(O3 ~ mes + year+station, dades.24hmod, FUN=mean)

df.month <- data.frame("PM2.5"=PM2.5$PM2.5 , "PM10"=PM10$PM10, "SO2"=SO2$SO2, "NO2"=NO2$NO2, "CO"=CO$CO, "O3"=O3$O3,"month"=O3$mes,"year" = O3$year,"station" = O3$station)
df.month$date <- make_date(year=O3$year,month = O3$mes)
rm(PM2.5,PM10,SO2,NO2,CO,O3)
```

Es visualitzen de nou els resultats en funció del temps i de l'estació de mesura.
```{r fig.height=18, fig.width=25}
p1<- ggplot(df.month,aes(x=date,y=PM2.5,color = station))+
  geom_line() + ggtitle("PM2.5 vs temps")
p2<- ggplot(df.month,aes(x=date,y=PM10,color = station))+
  geom_line() + ggtitle("PM10 vs temps")
p3<- ggplot(df.month,aes(x=date,y=SO2,color = station))+
  geom_line() + ggtitle("SO2 vs temps")
p4<- ggplot(df.month,aes(x=date,y=NO2,color = station))+
  geom_line() + ggtitle("NO2 vs temps")
p5<- ggplot(df.month,aes(x=date,y=CO,color = station))+
  geom_line() + ggtitle("CO vs temps")
p6<- ggplot(df.month,aes(x=date,y=O3,color = station))+
  geom_line() + ggtitle("O3 vs temps")

grid.arrange(p1, p2, p3, p4,p5,p6,ncol=2)

rm(p1,p2,p3,p4,p5,p6)
```

Per simplificar encara més els càlculs, es fa un promig de cada atribut per a totes les estacions i es tracten com a una única estació. A continuació es torna a mostrar les mateixes gràfiques dels diferents atributs.
```{r fig.height=18, fig.width=25}
PM2.5 <- aggregate(PM2.5 ~ mes + year, dades.24hmod, FUN=mean)
PM10 <- aggregate(PM10 ~ mes + year, dades.24hmod, FUN=mean)
SO2 <- aggregate(SO2 ~ mes + year, dades.24hmod, FUN=mean)
NO2 <- aggregate(NO2 ~ mes + year, dades.24hmod, FUN=mean)
CO <- aggregate(CO ~ mes + year, dades.24hmod, FUN=mean)
O3 <- aggregate(O3 ~ mes + year, dades.24hmod, FUN=mean)

df.month <- data.frame("PM2.5"=PM2.5$PM2.5 , "PM10"=PM10$PM10, "SO2"=SO2$SO2, "NO2"=NO2$NO2, "CO"=CO$CO, "O3"=O3$O3,"month"=O3$mes,"year" = O3$year)

df.month$date <- make_date(year=O3$year,month = O3$mes)
rm(PM2.5,PM10,SO2,NO2,CO,O3)

p1<- ggplot(df.month,aes(x=date,y=PM2.5))+
  geom_line() + ggtitle("PM2.5 vs temps")
p2<- ggplot(df.month,aes(x=date,y=PM10))+
  geom_line() + ggtitle("PM10 vs temps")
p3<- ggplot(df.month,aes(x=date,y=SO2))+
  geom_line() + ggtitle("SO2 vs temps")
p4<- ggplot(df.month,aes(x=date,y=NO2))+
  geom_line() + ggtitle("NO2 vs temps")
p5<- ggplot(df.month,aes(x=date,y=CO))+
  geom_line() + ggtitle("CO vs temps")
p6<- ggplot(df.month,aes(x=date,y=O3))+
  geom_line() + ggtitle("O3 vs temps")

grid.arrange(p1, p2, p3, p4,p5,p6,ncol=2)

rm(p1,p2,p3,p4,p5,p6)
```

De tots aquests atributs, únicament els atributs *SO2* i *O3* semblen que tinguin una certa tendència i periodicitat. S'estudiarà aquests atributs. La resta datributs presenten símptomes de soroll.

Primer es mostra la tendència, estacionaitat i soroll per l'atribut *SO2*.
```{r fig.height=10, fig.width=10}
tdf.ts <- ts(df.month$SO2,start = c(2013,3),end=c(2017,2), frequency=12)
monthly_stl <- stl(tdf.ts, s.window = "period")
plot(monthly_stl) 
```

Després es mostra la tendència, estacionalitat i soroll per l'atribut *O3*.
```{r fig.height=10, fig.width=10}
tdf.ts <- ts(df.month$O3,start = c(2013,3),end=c(2017,2), frequency=12)
monthly_stl <- stl(tdf.ts, s.window = "period")
plot(monthly_stl)
```
En ambdos casos es pot observa una estacionalitat clara i una tendencia en el cas de *SO2* decreixent i en el cas *O3* creixent. Aquets valors s'han extret segons la funció *decompose*. 

Anem a treballar amb els atributs *SO2* i *O3*. Primer volem veure si hi ha homoscedasticitat (variancia diferent envers el temps).

Per fer això, primer s'esudiarà si les dades tenn una distribució normal:
```{r fig.height=8, fig.width=10}

# Visualització de la distribució de les dades en funció de cada atribut
par(mfrow=c(2,3))

for(i in atributs){
  qqnorm(df.month[[i]], main=paste("Distribució ",i))
  qqline(df.month[[i]],col=2)
}

```

S'observa com ara molts atributs semblen que tenen una distribució normal, anem a corroborar-ho amb el test de *Shapiro*.
```{r}
for(i in atributs){
  aux <-shapiro.test(df.month[[i]])
  print(paste("Per l'atribut",i,"s'obté el valor p:", aux$p.value))
}
```

S'observa com els atributs *PM2.5* i *NO2* tenen distribucions normals amb una significancia del 5%. En canvi els atributs que volem estudiar *SO2* i *O3* no tenen una distribució normal per una significancia del 5%.

A continuació es calcula la homogeneiat de les dades, per poder procedir s'ha de tenir en compte que les dades no tenen una distribució normal, per aquest motiu s'estudiara segons *Fligner-Killeen*.

```{r}
# Definició dels atributs a estudiar:
atributs <- c("NO2","O3")

for(i in atributs){
  aux <-fligner.test(df.month[[i]],df.month$year)
  print(paste("Per l'atribut",i,"en funció de l'any de mesura s'obté el valor p:", aux$p.value))
}
```
 
En el cas del mes:
```{r}
for(i in atributs){
  aux <-fligner.test(df.month[[i]],df.month$month)
  print(paste("Per l'atribut",i,"en funció del mes de mesura s'obté el valor p:", aux$p.value))
}
```

Per tant, es conclou que es dos atributs són homogenis i no hi ha homoscedasticitat.

A continuació, es preten treure la tendència d'ambdos atributs de forma manual. Per fer-ho, es calcularà mitjantçant una regressió lineal.

El que es fa és:
- 1r: Calcular la tendència de les dades originals
- 2n: Extreure la tendència de les dades originals per obtenir l'estacionalitat

A continuació es següeixen aquests passos per *SO2* i *O3*.
```{r}
# Regressió lineal SO2
reg.SO2 <- lm(SO2~date,df.month)
summary(reg.SO2)
```

En aquest cas, s'està estudiant la tendència i estacionalitat de cada atribut per això no te gaire sentit analitzar els coeficients de determinació del resultat de la regressió. El coeficient de determinació indica quin tant percent del model explica la variança de les observacions.

Un cop es te la tendència calculada e procedeix per extreure l'estacionalitat de les dades.
```{r  fig.height=4, fig.width=8}
desc.so2 <- data.frame("original"=df.month$SO2,"date"=df.month$date,"tendencia"=reg.SO2$fitted.values)
desc.so2$estacionalitat <- desc.so2$original-desc.so2$tendencia
p1 <- ggplot(desc.so2, aes(x =date, y = original)) + geom_line() + geom_line(color = 'red',data =desc.so2,aes(x=date,y=tendencia))+ ggtitle("Dades original SO2 + tendència")
p2 <- ggplot(desc.so2, aes(x =date, y = estacionalitat)) + geom_line(color="blue") + ggtitle("Estacionalitat SO2")
grid.arrange(p1, p2,ncol=2)
rm(p1,p2)
```

Es repeteix el mateix estudi per *O3*.
```{r}
# Regressió lineal O3
reg.O3 <- lm(O3~date,df.month)
summary(reg.O3)
```

Un cop es te la tendència calculada e procedeix per extreure l'estacionalitat de les dades.
```{r  fig.height=4, fig.width=8}
desc.o3 <- data.frame("original"=df.month$O3,"date"=df.month$date,"tendencia"=reg.O3$fitted.values)
desc.o3$estacionalitat <- desc.o3$original-desc.o3$tendencia
p1 <- ggplot(desc.o3, aes(x =date, y = original)) + geom_line() + geom_line(color = 'red',data =desc.o3,aes(x=date,y=tendencia))+ ggtitle("Dades original O3 + tendència")
p2 <- ggplot(desc.o3, aes(x =date, y = estacionalitat)) + geom_line(color="blue")+ ggtitle("Estacionalitat O3")
grid.arrange(p1, p2,ncol=2)
rm(p1,p2)
```
S'observa com en ambdos casos hi ha una tendència clara i una estacionalitat perteptible. Això no succeeix en la resta d'atributs.


Amb l'objectiu de predir el comportament d'aquets atributs basant-nos en els seus valors històrics es genera un model SARIMA. Això es desenvolupa en el següent apartat.

### d) Predicció dels atributs SO2 i O3
El primer pas es dividir el set de dades en set de dades d'entrenament i set de test. Consierem que fins 2016 serà el model de train i a partir de llavors serà el set de dades de test.
```{r}
train <- df.month[df.month$year<=2015,]
test <- df.month[df.month$year>=2016,]
```

Amb les dades d'entrenament, es calcula la regressió lineal d'aquestes i després es substrau per calcular l'estacionalitat. 
```{r  fig.height=8, fig.width=8}
# Regressió lineal SO2
train.SO2 <- lm(SO2~date,train)
# Regressió lineal O3
train.O3 <- lm(O3~date,train)

#
train_desc.o3 <- data.frame("original"=train$O3,"date"=train$date,"tendencia"=train.O3$fitted.values)
train_desc.o3$estacionalitat <- train_desc.o3$original-train_desc.o3$tendencia
#
train_desc.so2 <- data.frame("original"=train$SO2,"date"=train$date,"tendencia"=train.SO2$fitted.values)
train_desc.so2$estacionalitat <- train_desc.so2$original-train_desc.so2$tendencia


p1 <- ggplot(train_desc.o3, aes(x =date, y = original)) + geom_line() + geom_line(color = 'red',data =train_desc.o3,aes(x=date,y=tendencia))+ ggtitle("Dades originals + tendència O3")
p2 <- ggplot(train_desc.o3, aes(x =date, y = estacionalitat)) + geom_line(color="blue")+ ggtitle("Estacionalitat O3")
p3 <- ggplot(train_desc.so2, aes(x =date, y = original)) + geom_line() + geom_line(color = 'red',data =train_desc.so2,aes(x=date,y=tendencia))+ ggtitle("Dades originals + tendència SO2")
p4 <- ggplot(train_desc.so2, aes(x =date, y = estacionalitat)) + geom_line(color="blue")+ ggtitle("Estacionalitat SO2")
grid.arrange(p1, p2,p3,p4,ncol=2)
rm(p1,p2,p3,p4)
```

Es busca quin és el model SARIMA que millor ajusta. Aquests models són complexos de calcular, però amb la funció *auto.arima*, et detrmina quin és el que millor ajusta:
```{r  warning=FALSE}
# SO2
myts <- ts(train_desc.so2$estacionalitat, start=c(2013,3), end=c(2015,12), frequency=12)
fit.so2 <- auto.arima(myts, seasonal = T)
# O3
myts <- ts(train_desc.o3$estacionalitat, start=c(2013,3), end=c(2015,12), frequency=12)
fit.o3 <- auto.arima(myts, seasonal = T)
```

Es mostren els models SARIMA generats i constrastats amb les dades d'estacionalitat.
```{r fig.height=4, fig.width=12, warning=FALSE}
colors <- c("Original Train" = "black", "Model SARIMA" = "red", "Prediccio" = "blue")

aux1 <- data_frame("y"=fit.so2$fitted,"x"=train_desc.so2$date)
aux2 <- data_frame("y"=fit.o3$fitted,"x"=train_desc.o3$date)

p1 <- ggplot(train_desc.so2, aes(x =date, y = estacionalitat)) + geom_line(aes(color="Original Train")) + geom_line(data =aux1,aes(x=x,y=y,color = "Model SARIMA"))+ ggtitle("Comparació SO2")+labs(color = "Llegenda") + scale_color_manual(values = colors)

p2 <- ggplot(train_desc.o3, aes(x =date, y = estacionalitat)) + geom_line(aes(color="Original Train")) + geom_line(data =aux2,aes(x=x,y=y,color = "Model SARIMA"))+ ggtitle("Comparació O3")+labs(color = "Llegenda") +scale_color_manual(values = colors)

grid.arrange(p1, p2,ncol=2)
rm(p1,p2)
```
S'observa que entre els models genrats SARIMA i les dades d'estacionalitat originals hi an diferències, no obstant sembla que ajustan força bé.

Es calcula la predicció del models SARIMA.
```{r fig.height=4, fig.width=10, message=FALSE, warning=FALSE}
# Es realitza la pedicció
prediction.so2 <- predict(fit.so2,n.ahead = 14)
prediction.o3 <- predict(fit.o3,n.ahead = 14)

# Es guarden els resultats en data frames
aux3 <- data_frame("y"=prediction.so2$pred,"x"=test$date)
aux4 <- data_frame("y"=prediction.o3$pred,"x"=test$date)

p1 <- ggplot(aux3, aes(x =x, y = y)) + geom_line(aes(color="Prediccio"))+ ggtitle("Predicció estacionalitat SO2")+labs(color = "Llegenda") +scale_color_manual(values = colors)
p2 <- ggplot(aux4, aes(x =x, y = y)) + geom_line(aes(color="Prediccio"))+ ggtitle("Predicció estacionalitat O3")+labs(color = "Llegenda") +scale_color_manual(values = colors)

grid.arrange(p1, p2,ncol=2)
rm(p1,p2)
```


Un cop es tenen les prediccions del models SARIMA, es generen les prediccions dels models de regressió lineal. Un cop es tinguin calculades, es sumaran les tendències predites amb els models predits SARIMA.
```{r}
# Calcul de la predicció de la regressió lineal
# Regressió lineal SO2: train.SO2 lm(SO2~date,train)
# Regressió lineal O3: train.O3  lm(O3~date,train)
new_so2 <- test
new_o3 <- test
pred.lmso2 <- predict(train.SO2,new_so2)
pred.lmo3 <- predict(train.O3,new_o3)

# Es suma el valor de la regresió lineal amb el valor calculat de l'estacionalitat
# so2
aux3$pendent <- pred.lmso2 # Es copia el pendent predit
aux3$reconstruccio <- aux3$y+pred.lmso2 # Es suma el pendent i les dades estacionals predites
# o3
aux4$pendent <- pred.lmo3 # Es copia el pendent predit
aux4$reconstruccio  <- aux4$y+pred.lmo3 # Es suma el pendent i les dades estacionals predites
```

A continuació es mostra les dades.
```{r  fig.height=4, fig.width=12}
colors <- c("Dades originals" = "black", "Model SARIMA" = "red", "Prediccio" = "blue")
# SO2
aux1$reconstruccio <- aux1$y+train.SO2$fitted.values # Es suma el pendent i les dades estacionals
p1 <- ggplot(df.month, aes(x =date, y = SO2)) + geom_line(aes(color="Dades originals")) + geom_line(data =aux1,aes(x=x,y=reconstruccio,color="Model SARIMA"))+ geom_line(data =aux3,aes(x=x,y=reconstruccio,color="Prediccio"))+ ggtitle("Reconstrucció SO2")+ ggtitle("Predicció estacionalitat O3")+labs(color = "Llegenda") +scale_color_manual(values = colors)

# O3
aux2$reconstruccio <- aux2$y+train.O3$fitted.values # Es suma el pendent i les dades estacionals
p2 <- ggplot(df.month, aes(x =date, y = O3)) + geom_line(aes(color="Dades originals")) + geom_line(data =aux2,aes(x=x,y=reconstruccio,color="Model SARIMA"))+ geom_line(data =aux4,aes(x=x,y=reconstruccio,color="Prediccio")) +ggtitle("Reconstrucció O3")+ ggtitle("Predicció estacionalitat O3")+labs(color = "Llegenda") +scale_color_manual(values = colors)

grid.arrange(p1, p2,ncol=2)
rm(p1,p2)
```

S'observa com hi ha una reconstrucció força similar però no encaixa amb molta exactitud.

# 5. Conclusions

Amb l'estudi realitzat podem obtenir les següents conclusions:

- Les condicions climàtiques son molt importants a l'hora d'estudiar la contaminació. En l'exemple observem que aquesta és més alta durant les èpoques de més calor i de menys pluja. Osbservem també dependència amb la direcció i la velocitat del vent.
- El conjunt d'anàlisis presenta diversos valors perduts, distribuïts uniformement en el conjunt, cosa que indicaria que el procés de captura o de recollida de dades falla de forma ocasional i que s'hauria de millorar.
- El conjunt presenta també diversos valors extrems però no semblen poder-se atribuir a cap anomalia en la recollida de dades.
- Observem una forta component estacionaria de les variables estudiades al llarg del temps, que per exemple ens permeten concloure que la presència d'alguns contaminants és molt més pronunciada en els mesos d'estiu.
- En general s'observa que els valors dels contaminants, prenent com a referència estàndards europeus, estan molt per sobre dels valors recomanats, tant en mitjanes diàries com anuals.
- La descomposció de les sèries temporals ens permet observar també una component periòdica tant en els dies com en els anys. En aquest cas, la component estacionària de les dades, ens mostra una certa tendència creixent (en general) al llarg dels 4 anys de l'estudi, tot i que aquesta no es pot dir que sigui significativa amb les dades disponibles.
- Les dades no son normals ni presenten homogeneitat de variances, de manera que no es poden obtenir conclusions sobre la majoria dels indicadors ni realitzar les proves estadístiques habituals. Per tant tote les proves estadístiques es realitzen amb funcions que obvien la distribució de cadascuna de les variables.
- L'estudi de les dades mitjançant Kruskal ens permet concloure que hi ha una diferència significativa entre les mitjanes de les diferents estacions, cosa que indicaria que hi ha zones de la ciutat significativament més contaminades que d'altres.
- L'estudi també ens permet concloure que hi ha diferències significatives en els diferents anys de mesura, cosa que indicaria que efectivament la contaminació hauria anat en augment entre els anys 2013 i 2017, quan es realitzà l'estudi.
- L'estudi de correlacions entre les variables indica també una correlació positiva entre els diferents indicadors de contaminació estudiats. Aquest resultat permetria concloure, per exemple, que una major concentració de PM10 implica una major concentració de CO2 o de NO2 i que en canvi una major concentració de O3 indica una menor concentració d'aquests indicadors.
- S'ha realitzat l'estidu de tendències i estacionalitat dels atributs *SO2* i *O3*. En aquest estudi s'han dividit les ddes en 2 conjunts, un d'entrenament i un de test, amb a finalitat de dur a terme una previsió. S'han utilitzat regressions lineals i models SARIMA per realitzar les previsions i els resultats obtinguts ha sigut satisfactoris degut a ue les previsions ajustaven força a les dades originals. Tot i això aquestes es poden millorar, rtreballant més les dades.
